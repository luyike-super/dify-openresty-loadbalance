# x86_64优化的OpenResty主配置
user nobody;
worker_processes auto;
error_log /dev/stdout info;
pid /var/run/openresty.pid;

# x86_64性能优化
worker_rlimit_nofile 65535;
worker_cpu_affinity auto;

events {
    worker_connections 8192;  # x86可以支持更多连接
    use epoll;
    multi_accept on;
    accept_mutex off;
}

http {
    # 包含MIME类型
    include mime.types;
    default_type application/octet-stream;
    charset utf-8;

    # Lua包路径和优化配置
    lua_package_path "/usr/local/openresty/lualib/?.lua;/usr/local/openresty/lualib/app/?.lua;;";
    lua_code_cache on;
    lua_socket_buffer_size 64k;        # 增加socket缓冲区
    lua_socket_pool_size 30;           # socket连接池大小
    lua_socket_keepalive_timeout 60s;  # socket keepalive超时
    lua_socket_connect_timeout 10s;    # socket连接超时
    lua_socket_send_timeout 10s;       # socket发送超时
    lua_socket_read_timeout 10s;       # socket读取超时

    # 共享字典定义（用于缓存和统计）
    lua_shared_dict app_config 10m;
    lua_shared_dict hash_ring 10m;
    lua_shared_dict stats 10m;

    # x86_64性能优化配置
    sendfile on;
    sendfile_max_chunk 2M;  # x86可以使用更大的chunk
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 1000;
    types_hash_max_size 2048;
    server_names_hash_bucket_size 128;
    # 客户端请求体配置（优化大文件上传性能）
    client_max_body_size 100M;
    client_body_timeout 60s;           # 增加超时时间
    client_header_timeout 30s;
    client_body_buffer_size 1M;        # 设置合适的缓冲区大小
    client_body_temp_path /tmp/nginx_client_body_temp 1 2;
    client_body_in_file_only off;      # 小文件保持在内存中
    client_body_in_single_buffer on;   # 尝试在单个缓冲区中读取

    # 隐藏服务器信息
    server_tokens off;

    # Gzip压缩配置
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_comp_level 6;  # x86可以使用更高的压缩级别
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # 代理配置
    proxy_buffering on;
    proxy_buffer_size 32k;     # x86优化缓冲区大小
    proxy_buffers 32 32k;
    proxy_busy_buffers_size 64k;
    proxy_temp_file_write_size 64k;
    proxy_connect_timeout 15s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # 企业级结构化日志格式
    # 主访问日志 - JSON格式，便于日志分析系统解析
    log_format json_main escape=json
        '{'
            '"timestamp":"$time_iso8601",'
            '"request_id":"$request_id",'
            '"remote_addr":"$remote_addr",'
            '"remote_user":"$remote_user",'
            '"request_method":"$request_method",'
            '"request_uri":"$request_uri",'
            '"server_protocol":"$server_protocol",'
            '"status":$status,'
            '"body_bytes_sent":$body_bytes_sent,'
            '"request_time":$request_time,'
            '"upstream_response_time":"$upstream_response_time",'
            '"upstream_addr":"$upstream_addr",'
            '"upstream_status":"$upstream_status",'
            '"http_referer":"$http_referer",'
            '"http_user_agent":"$http_user_agent",'
            '"http_x_forwarded_for":"$http_x_forwarded_for",'
            '"http_x_real_ip":"$http_x_real_ip",'
            '"server_name":"$server_name",'
            '"connection":$connection,'
            '"connection_requests":$connection_requests'
        '}';

    # 应用路由日志 - 包含业务相关信息
    log_format app_routing escape=json
        '{'
            '"timestamp":"$time_iso8601",'
            '"request_id":"$request_id",'
            '"remote_addr":"$remote_addr",'
            '"request_method":"$request_method",'
            '"request_uri":"$request_uri",'
            '"status":$status,'
            '"body_bytes_sent":$body_bytes_sent,'
            '"request_time":$request_time,'
            '"upstream_response_time":"$upstream_response_time",'
            '"upstream_addr":"$upstream_addr",'
            '"upstream_status":"$upstream_status",'
            '"app_type":"$app_type",'
            '"user_id":"$user_id",'
            '"backend_instance":"$backend_instance",'
            '"hash_key":"$hash_key",'
            '"http_user_agent":"$http_user_agent",'
            '"http_x_forwarded_for":"$http_x_forwarded_for"'
        '}';

    # 安全审计日志 - 记录安全相关事件
    log_format security_audit escape=json
        '{'
            '"timestamp":"$time_iso8601",'
            '"request_id":"$request_id",'
            '"event_type":"access_attempt",'
            '"remote_addr":"$remote_addr",'
            '"request_method":"$request_method",'
            '"request_uri":"$request_uri",'
            '"status":$status,'
            '"user_agent":"$http_user_agent",'
            '"x_forwarded_for":"$http_x_forwarded_for",'
            '"auth_header_present":"$http_authorization",'
            '"app_type":"$app_type",'
            '"user_id":"$user_id",'
            '"backend_instance":"$backend_instance"'
        '}';

    # 性能监控日志 - 专注于性能指标
    log_format performance escape=json
        '{'
            '"timestamp":"$time_iso8601",'
            '"request_id":"$request_id",'
            '"request_time":$request_time,'
            '"upstream_response_time":"$upstream_response_time",'
            '"upstream_connect_time":"$upstream_connect_time",'
            '"upstream_header_time":"$upstream_header_time",'
            '"body_bytes_sent":$body_bytes_sent,'
            '"request_length":$request_length,'
            '"connection":$connection,'
            '"connection_requests":$connection_requests,'
            '"app_type":"$app_type",'
            '"backend_instance":"$backend_instance",'
            '"status":$status'
        '}';

    # 错误日志格式 - 详细的错误信息
    log_format error_detail escape=json
        '{'
            '"timestamp":"$time_iso8601",'
            '"request_id":"$request_id",'
            '"level":"error",'
            '"remote_addr":"$remote_addr",'
            '"request_method":"$request_method",'
            '"request_uri":"$request_uri",'
            '"status":$status,'
            '"upstream_status":"$upstream_status",'
            '"upstream_addr":"$upstream_addr",'
            '"app_type":"$app_type",'
            '"user_id":"$user_id",'
            '"backend_instance":"$backend_instance",'
            '"error_message":"$upstream_http_x_error_message"'
        '}';

    # 传统格式日志（兼容性）
    log_format main '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   '"$http_x_forwarded_for" rt=$request_time';

    # WebSocket升级处理
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # 包含站点配置
    include /usr/local/openresty/nginx/conf/conf.d/*.conf;
}