# Dify OpenResty è´Ÿè½½å‡è¡¡å™¨é¡¹ç›®æ–‡æ¡£

## ğŸ“‹ éœ€æ±‚èƒŒæ™¯

### ä¸šåŠ¡åœºæ™¯

åœ¨ä¼ä¸šçº§Dify AIåº”ç”¨éƒ¨ç½²ä¸­ï¼Œå•ä¸€å®ä¾‹å¾€å¾€æ— æ³•æ»¡è¶³é«˜å¹¶å‘å’Œé«˜å¯ç”¨æ€§çš„éœ€æ±‚ã€‚ç‰¹åˆ«æ˜¯åœ¨ä»¥ä¸‹åœºæ™¯ä¸‹ï¼š

- **å¤šåº”ç”¨åœºæ™¯**ï¼šä¼ä¸šéœ€è¦åŒæ—¶è¿è¡Œå¤šä¸ªAIåº”ç”¨ï¼ˆå¦‚æ™ºèƒ½å®¢æœã€å†…å®¹ç”Ÿæˆã€æ•°æ®åˆ†æç­‰ï¼‰
- **é«˜å¹¶å‘éœ€æ±‚**ï¼šå•ä¸ªåº”ç”¨å®ä¾‹æ— æ³•å¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚
- **é«˜å¯ç”¨è¦æ±‚**ï¼šéœ€è¦é¿å…å•ç‚¹æ•…éšœï¼Œç¡®ä¿æœåŠ¡è¿ç»­æ€§
- **èµ„æºä¼˜åŒ–**ï¼šéœ€è¦æ ¹æ®ä¸åŒåº”ç”¨çš„ç‰¹ç‚¹è¿›è¡Œèµ„æºåˆ†é…å’Œè´Ÿè½½åˆ†æ‹…
- **ç”¨æˆ·éš”ç¦»**ï¼šä¸åŒç”¨æˆ·æˆ–ç§Ÿæˆ·éœ€è¦è®¿é—®ä¸åŒçš„åº”ç”¨å®ä¾‹

### æŠ€æœ¯æŒ‘æˆ˜

1. **æ™ºèƒ½è·¯ç”±**ï¼šéœ€è¦æ ¹æ®ç”¨æˆ·Tokenè‡ªåŠ¨è¯†åˆ«åº”ç”¨ç±»å‹å¹¶è·¯ç”±åˆ°å¯¹åº”å®ä¾‹
2. **è´Ÿè½½å‡è¡¡**ï¼šéœ€è¦å®ç°é«˜æ•ˆçš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œç¡®ä¿è¯·æ±‚å‡åŒ€åˆ†å¸ƒ
3. **æ•…éšœè½¬ç§»**ï¼šå½“æŸä¸ªå®ä¾‹æ•…éšœæ—¶ï¼Œéœ€è¦è‡ªåŠ¨åˆ‡æ¢åˆ°å¥åº·å®ä¾‹
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šéœ€è¦é’ˆå¯¹x86_64æ¶æ„è¿›è¡Œæ€§èƒ½ä¼˜åŒ–
5. **ç›‘æ§ç»Ÿè®¡**ï¼šéœ€è¦å®æ—¶ç›‘æ§å„å®ä¾‹çŠ¶æ€å’Œè¯·æ±‚åˆ†å¸ƒ

## ğŸ”„ éœ€æ±‚æµç¨‹

### ç”¨æˆ·è¯·æ±‚æµç¨‹

```
ç”¨æˆ·è¯·æ±‚ â†’ OpenRestyè´Ÿè½½å‡è¡¡å™¨ â†’ Tokenè§£æ â†’ åº”ç”¨è¯†åˆ« â†’ ä¸€è‡´æ€§å“ˆå¸Œé€‰æ‹©å®ä¾‹ â†’ åç«¯Difyå®ä¾‹ â†’ å“åº”è¿”å›
```

### è¯¦ç»†æµç¨‹è¯´æ˜

1. **è¯·æ±‚æ¥æ”¶**ï¼šOpenRestyæ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„HTTPè¯·æ±‚
2. **Tokenæå–**ï¼šä»Authorizationå¤´ä¸­æå–Bearer Token
3. **åº”ç”¨è¯†åˆ«**ï¼šæ ¹æ®TokenåŒ¹é…å¯¹åº”çš„åº”ç”¨ç±»å‹ï¼ˆcustomer_serviceã€content_generatorç­‰ï¼‰
4. **å®ä¾‹é€‰æ‹©**ï¼šä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•é€‰æ‹©æœ€ä¼˜åç«¯å®ä¾‹
5. **å¥åº·æ£€æŸ¥**ï¼šéªŒè¯é€‰ä¸­å®ä¾‹çš„å¥åº·çŠ¶æ€
6. **è¯·æ±‚è½¬å‘**ï¼šå°†è¯·æ±‚ä»£ç†åˆ°é€‰ä¸­çš„åç«¯å®ä¾‹
7. **å“åº”å¤„ç†**ï¼šå¤„ç†åç«¯å“åº”å¹¶è¿”å›ç»™å®¢æˆ·ç«¯
8. **ç»Ÿè®¡è®°å½•**ï¼šè®°å½•è¯·æ±‚ç»Ÿè®¡ä¿¡æ¯ç”¨äºç›‘æ§

### æ•…éšœå¤„ç†æµç¨‹

```
å®ä¾‹æ•…éšœæ£€æµ‹ â†’ æ ‡è®°å®ä¾‹ä¸å¯ç”¨ â†’ é‡æ–°é€‰æ‹©å¥åº·å®ä¾‹ â†’ æ›´æ–°Hashç¯ â†’ ç»§ç»­æœåŠ¡
```

## ğŸ—ï¸ æ¶æ„å®ç°

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯åº”ç”¨    â”‚â”€â”€â”€â–¶â”‚  OpenRestyè´Ÿè½½å‡è¡¡å™¨  â”‚â”€â”€â”€â–¶â”‚  Difyå®ä¾‹é›†ç¾¤   â”‚
â”‚  (Web/Mobile)   â”‚    â”‚   (ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•)    â”‚    â”‚ (å¤šåº”ç”¨å¤šå®ä¾‹)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚  ç›‘æ§ç»Ÿè®¡API â”‚
                       â”‚ (/status)    â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. OpenRestyè´Ÿè½½å‡è¡¡å™¨
- **åŸºç¡€é•œåƒ**ï¼š`openresty/openresty:1.21.4.3-3-alpine-fat`
- **æ ¸å¿ƒåŠŸèƒ½**ï¼šHTTPè´Ÿè½½å‡è¡¡ã€Luaè„šæœ¬æ‰§è¡Œã€SSLç»ˆç«¯
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé’ˆå¯¹x86_64æ¶æ„ä¼˜åŒ–ï¼Œæ”¯æŒ8192å¹¶å‘è¿æ¥

#### 2. ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•
- **ç®—æ³•å®ç°**ï¼šåŸºäºSHA-256çš„ä¸€è‡´æ€§å“ˆå¸Œ
- **è™šæ‹ŸèŠ‚ç‚¹**ï¼šæ¯ä¸ªç‰©ç†èŠ‚ç‚¹å¯¹åº”160ä¸ªè™šæ‹ŸèŠ‚ç‚¹
- **è´Ÿè½½å‡è¡¡**ï¼šç¡®ä¿è¯·æ±‚å‡åŒ€åˆ†å¸ƒï¼Œæ”¯æŒèŠ‚ç‚¹åŠ¨æ€æ·»åŠ /åˆ é™¤

#### 3. åº”ç”¨é…ç½®ç®¡ç†
- **é…ç½®æ–‡ä»¶**ï¼š`config.lua`é›†ä¸­ç®¡ç†æ‰€æœ‰åº”ç”¨é…ç½®
- **åŠ¨æ€é‡è½½**ï¼šæ”¯æŒé€šè¿‡APIçƒ­é‡è½½é…ç½®
- **å¤šåº”ç”¨æ”¯æŒ**ï¼šæ”¯æŒå¤šä¸ªç‹¬ç«‹çš„Difyåº”ç”¨å®ä¾‹

#### 4. å¥åº·æ£€æŸ¥æœºåˆ¶
- **ä¸»åŠ¨æ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥åç«¯å®ä¾‹å¥åº·çŠ¶æ€
- **è¢«åŠ¨æ£€æŸ¥**ï¼šæ ¹æ®è¯·æ±‚å¤±è´¥æƒ…å†µåˆ¤æ–­å®ä¾‹çŠ¶æ€
- **æ•…éšœè½¬ç§»**ï¼šè‡ªåŠ¨å‰”é™¤æ•…éšœå®ä¾‹ï¼Œæ¢å¤åè‡ªåŠ¨åŠ å…¥

### æŠ€æœ¯æ ˆ

- **WebæœåŠ¡å™¨**ï¼šOpenResty (Nginx + LuaJIT)
- **è´Ÿè½½å‡è¡¡ç®—æ³•**ï¼šä¸€è‡´æ€§å“ˆå¸Œ (Consistent Hashing)
- **é…ç½®ç®¡ç†**ï¼šLuaé…ç½®æ–‡ä»¶
- **å®¹å™¨åŒ–**ï¼šDocker + Docker Compose
- **ç›‘æ§**ï¼šå†…ç½®çŠ¶æ€API + æ—¥å¿—è®°å½•

### ç›®å½•ç»“æ„

```
dify-openresty-loadbalancer/
â”œâ”€â”€ docker-compose.yml          # Dockerç¼–æ’æ–‡ä»¶
â”œâ”€â”€ openresty/                  # OpenRestyé…ç½®ç›®å½•
â”‚   â”œâ”€â”€ conf/                   # Nginxé…ç½®
â”‚   â”‚   â”œâ”€â”€ nginx.conf         # ä¸»é…ç½®æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ conf.d/            # è™šæ‹Ÿä¸»æœºé…ç½®
â”‚   â”‚       â””â”€â”€ dify-loadbalancer.conf
â”‚   â”œâ”€â”€ lua/                   # Luaè„šæœ¬
â”‚   â”‚   â”œâ”€â”€ config.lua         # åº”ç”¨é…ç½®
â”‚   â”‚   â”œâ”€â”€ loadbalancer.lua   # è´Ÿè½½å‡è¡¡æ ¸å¿ƒé€»è¾‘
â”‚   â”‚   â””â”€â”€ consistent_hash.lua # ä¸€è‡´æ€§å“ˆå¸Œå®ç°
â”‚   â”œâ”€â”€ logs/                  # æ—¥å¿—ç›®å½•
â”‚   â””â”€â”€ ssl/                   # SSLè¯ä¹¦ç›®å½•
â””â”€â”€ scripts/                   # éƒ¨ç½²è„šæœ¬

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### ç¯å¢ƒè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**ï¼šLinux (æ¨èUbuntu 20.04+)
- **æ¶æ„**ï¼šx86_64
- **Docker**ï¼š20.10+
- **Docker Compose**ï¼š2.0+
- **å†…å­˜**ï¼šå»ºè®®4GB+
- **CPU**ï¼šå»ºè®®4æ ¸+

### å¿«é€Ÿå¼€å§‹

#### 1. å…‹éš†é¡¹ç›®

```bash
git clone <repository-url>
cd dify-openresty-loadbalancer
```

#### 2. é…ç½®åº”ç”¨å®ä¾‹

ç¼–è¾‘ `openresty/lua/config.lua` æ–‡ä»¶ï¼Œé…ç½®ä½ çš„Difyåº”ç”¨å®ä¾‹ï¼š

```lua
config.applications = {
    -- æ™ºèƒ½å®¢æœåº”ç”¨
    customer_service = {
        user_tokens = {
            "usertoken--customer-service-v1"
        },
        instances = {
            {
                name = "dify1",
                host = "172.20.62.200",  -- ä½ çš„Difyå®ä¾‹IP
                port = 80,
                token = "app-9VSEFXR2qoMRoUHfmzxClGhe",  -- ä½ çš„åº”ç”¨Token
                weight = 1,
                max_fails = 3,
                fail_timeout = 30
            }
            -- æ·»åŠ æ›´å¤šå®ä¾‹...
        }
    }
    -- æ·»åŠ æ›´å¤šåº”ç”¨...
}
```

#### 3. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨è´Ÿè½½å‡è¡¡å™¨
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

#### 4. éªŒè¯æœåŠ¡

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:82/health

# æŸ¥çœ‹è´Ÿè½½å‡è¡¡çŠ¶æ€
curl http://localhost:82/status
```

### é…ç½®è¯´æ˜

#### åº”ç”¨é…ç½®å‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `name` | å®ä¾‹åç§° | `"dify1"` |
| `host` | å®ä¾‹IPåœ°å€ | `"192.168.1.100"` |
| `port` | å®ä¾‹ç«¯å£ | `80` |
| `token` | Difyåº”ç”¨Token | `"app-xxx"` |
| `weight` | æƒé‡ | `1` |
| `max_fails` | æœ€å¤§å¤±è´¥æ¬¡æ•° | `3` |
| `fail_timeout` | å¤±è´¥è¶…æ—¶æ—¶é—´(ç§’) | `30` |

#### ç”¨æˆ·Tokené…ç½®

æ¯ä¸ªåº”ç”¨éœ€è¦é…ç½®å¯¹åº”çš„ç”¨æˆ·Tokenåˆ—è¡¨ï¼Œç”¨äºè¯†åˆ«è¯·æ±‚åº”è¯¥è·¯ç”±åˆ°å“ªä¸ªåº”ç”¨ï¼š

```lua
user_tokens = {
    "user-token-1",
    "user-token-2"
}
```

### APIæ¥å£

#### 1. å¥åº·æ£€æŸ¥

```bash
GET /health
```

å“åº”ï¼š
```
healthy
```

#### 2. è´Ÿè½½å‡è¡¡çŠ¶æ€

```bash
GET /status
```

å“åº”ï¼š
```json
{
    "status": "running",
    "architecture": "x86_64",
    "algorithm": "consistent_hash",
    "stats": {
        "total_requests": 1000,
        "active_connections": 50
    },
    "timestamp": 1640995200
}
```

#### 3. é…ç½®é‡è½½

```bash
GET /reload-config
```

å“åº”ï¼š
```json
{
    "status": "success",
    "message": "Configuration reloaded"
}
```

### å®¢æˆ·ç«¯ä½¿ç”¨

#### è¯·æ±‚æ ¼å¼

å®¢æˆ·ç«¯è¯·æ±‚éœ€è¦åŒ…å«æ­£ç¡®çš„Authorizationå¤´ï¼š

```bash
curl -X POST http://localhost:82/v1/chat-messages \
  -H "Authorization: Bearer usertoken--customer-service-v1" \
  -H "Content-Type: application/json" \
  -d '{
    "inputs": {},
    "query": "Hello",
    "response_mode": "streaming",
    "conversation_id": "",
    "user": "user-123"
  }'
```

#### è·¯ç”±é€»è¾‘

1. è´Ÿè½½å‡è¡¡å™¨æå–Bearer Token
2. æ ¹æ®TokenåŒ¹é…å¯¹åº”çš„åº”ç”¨ç±»å‹
3. ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•é€‰æ‹©åç«¯å®ä¾‹
4. å°†è¯·æ±‚è½¬å‘åˆ°é€‰ä¸­çš„å®ä¾‹

### ç›‘æ§å’Œæ—¥å¿—

#### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹è®¿é—®æ—¥å¿—
docker-compose logs openresty-dify-lb

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f openresty-dify-lb

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker exec dify-openresty-loadbalancer tail -f /var/log/openresty/error.log
```

#### æ€§èƒ½ç›‘æ§

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats dify-openresty-loadbalancer

# æŸ¥çœ‹ç½‘ç»œè¿æ¥
docker exec dify-openresty-loadbalancer netstat -an | grep :80
```

### æ•…éšœæ’é™¤

#### å¸¸è§é—®é¢˜

1. **æœåŠ¡æ— æ³•å¯åŠ¨**
   - æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š`netstat -tlnp | grep :82`
   - æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•ï¼š`docker-compose config`

2. **è¯·æ±‚è·¯ç”±å¤±è´¥**
   - æ£€æŸ¥Tokené…ç½®æ˜¯å¦æ­£ç¡®
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š`docker-compose logs openresty-dify-lb`

3. **åç«¯å®ä¾‹è¿æ¥å¤±è´¥**
   - æ£€æŸ¥åç«¯å®ä¾‹æ˜¯å¦æ­£å¸¸è¿è¡Œ
   - éªŒè¯ç½‘ç»œè¿é€šæ€§ï¼š`docker exec dify-openresty-loadbalancer ping <backend-ip>`

#### é…ç½®çƒ­é‡è½½

ä¿®æ”¹é…ç½®åæ— éœ€é‡å¯æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡APIçƒ­é‡è½½ï¼š

```bash
# ä¿®æ”¹é…ç½®æ–‡ä»¶å
curl http://localhost:82/reload-config
```

### æ€§èƒ½ä¼˜åŒ–

#### x86_64æ¶æ„ä¼˜åŒ–

æœ¬é¡¹ç›®é’ˆå¯¹x86_64æ¶æ„è¿›è¡Œäº†ä»¥ä¸‹ä¼˜åŒ–ï¼š

- **å¹¶å‘è¿æ¥æ•°**ï¼šæ”¯æŒ8192å¹¶å‘è¿æ¥
- **CPUäº²å’Œæ€§**ï¼šè‡ªåŠ¨ç»‘å®šCPUæ ¸å¿ƒ
- **å†…å­˜ä¼˜åŒ–**ï¼šä¼˜åŒ–å…±äº«å­—å…¸å¤§å°
- **ç½‘ç»œä¼˜åŒ–**ï¼šå¯ç”¨sendfileã€tcp_nopushç­‰

#### èµ„æºé…ç½®

åœ¨ `docker-compose.yml` ä¸­å¯ä»¥è°ƒæ•´èµ„æºé™åˆ¶ï¼š

```yaml
deploy:
  resources:
    limits:
      cpus: '4.0'    # CPUé™åˆ¶
      memory: 4G     # å†…å­˜é™åˆ¶
    reservations:
      cpus: '1.0'    # CPUé¢„ç•™
      memory: 1G     # å†…å­˜é¢„ç•™
```

### æ‰©å±•åŠŸèƒ½

#### æ·»åŠ æ–°åº”ç”¨

1. åœ¨ `config.lua` ä¸­æ·»åŠ æ–°åº”ç”¨é…ç½®
2. é…ç½®å¯¹åº”çš„ç”¨æˆ·Token
3. æ·»åŠ åç«¯å®ä¾‹ä¿¡æ¯
4. é‡è½½é…ç½®ï¼š`curl http://localhost:82/reload-config`

#### SSL/HTTPSæ”¯æŒ

1. å°†SSLè¯ä¹¦æ”¾å…¥ `openresty/ssl/` ç›®å½•
2. ä¿®æ”¹ `docker-compose.yml` å¼€æ”¾443ç«¯å£
3. åœ¨nginxé…ç½®ä¸­æ·»åŠ SSLé…ç½®

#### è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç®—æ³•

å¯ä»¥åœ¨ `consistent_hash.lua` ä¸­å®ç°è‡ªå®šä¹‰çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå¦‚ï¼š
- åŠ æƒè½®è¯¢
- æœ€å°‘è¿æ¥
- IPå“ˆå¸Œ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- é¡¹ç›®Issues
- æŠ€æœ¯æ–‡æ¡£
- ç¤¾åŒºè®ºå›

---

*æœ¬æ–‡æ¡£æŒç»­æ›´æ–°ä¸­ï¼Œæœ€åæ›´æ–°æ—¶é—´ï¼š2024å¹´*

# å¦‚æœæœ‰è‡ªå®šä¹‰nginxé…ç½®
cp -r nginx /tmp/dify-backup/ 2>/dev/null || true
```

### 1.6 æ‰“åŒ…å¤‡ä»½æ–‡ä»¶

```bash
# åˆ›å»ºå®Œæ•´å¤‡ä»½åŒ…
cd /tmp
tar czf dify-migration-$(date +%Y%m%d-%H%M%S).tar.gz dify-backup/

# æ˜¾ç¤ºå¤‡ä»½åŒ…ä¿¡æ¯
ls -lh dify-migration-*.tar.gz
```

## ğŸ“¦ ç¬¬äºŒæ­¥ï¼šä¼ è¾“å¤‡ä»½åˆ°ç›®æ ‡æœåŠ¡å™¨

### 2.1 ä½¿ç”¨SCPä¼ è¾“ï¼ˆæ¨èï¼‰

```bash
# ä»æºæœåŠ¡å™¨æ‰§è¡Œ
scp /tmp/dify-migration-*.tar.gz username@target-server-ip:/tmp/

# æˆ–è€…ä½¿ç”¨rsyncï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰
rsync -avz --progress /tmp/dify-migration-*.tar.gz username@target-server-ip:/tmp/
```

### 2.2 å…¶ä»–ä¼ è¾“æ–¹å¼

```bash
# å¦‚æœç½‘ç»œä¸é€šï¼Œå¯ä»¥ä½¿ç”¨Uç›˜ç­‰ç‰©ç†ä»‹è´¨
# æˆ–è€…é€šè¿‡ä¸­è½¬æœåŠ¡å™¨è¿›è¡Œä¼ è¾“
```

## ğŸš€ ç¬¬ä¸‰æ­¥ï¼šç›®æ ‡æœåŠ¡å™¨éƒ¨ç½²æ“ä½œ

### 3.1 å‡†å¤‡ç›®æ ‡æœåŠ¡å™¨ç¯å¢ƒ

```bash
# å®‰è£…Dockerï¼ˆå¦‚æœªå®‰è£…ï¼‰
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER

# å®‰è£…Docker Composeï¼ˆå¦‚æœªå®‰è£…ï¼‰
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# é‡æ–°ç™»å½•ä»¥åº”ç”¨dockerç»„æƒé™
sudo su - $USER
```

### 3.2 è§£å‹å¤‡ä»½æ–‡ä»¶

```bash
# è§£å‹å¤‡ä»½åŒ…
cd /tmp
tar xzf dify-migration-*.tar.gz

# æŸ¥çœ‹å¤‡ä»½å†…å®¹
ls -la dify-backup/
```

### 3.3 å¯¼å…¥Dockeré•œåƒ

```bash
# å¯¼å…¥é•œåƒ
gunzip -c /tmp/dify-backup/dify-images.tar.gz | docker load

# æˆ–è€…å¦‚æœæ²¡æœ‰å‹ç¼©
# docker load -i /tmp/dify-backup/dify-images.tar

# éªŒè¯é•œåƒå¯¼å…¥
docker images | grep -E "(dify|postgres|redis|nginx|weaviate)"
```

### 3.4 åˆ›å»ºéƒ¨ç½²ç›®å½•å¹¶æ¢å¤é…ç½®

```bash
# åˆ›å»ºDifyéƒ¨ç½²ç›®å½•
mkdir -p /opt/dify
cd /opt/dify

# å¤åˆ¶é…ç½®æ–‡ä»¶
cp /tmp/dify-backup/docker-compose.yaml .
cp /tmp/dify-backup/.env .

# å¦‚æœæœ‰nginxé…ç½®
cp -r /tmp/dify-backup/nginx . 2>/dev/null || true
```

### 3.5 åˆ›å»ºDockerå·å¹¶æ¢å¤æ•°æ®

```bash
# åˆ›å»ºæ•°æ®å·
docker volume create dify_db_data
docker volume create dify_redis_data
docker volume create dify_app_storage

# æ¢å¤æ•°æ®åº“æ•°æ®
docker run --rm -v dify_db_data:/data -v /tmp/dify-backup:/backup alpine tar xzf /backup/dify-database.tar.gz -C /data

# æ¢å¤Redisæ•°æ®
docker run --rm -v dify_redis_data:/data -v /tmp/dify-backup:/backup alpine tar xzf /backup/dify-redis.tar.gz -C /data

# æ¢å¤å­˜å‚¨æ–‡ä»¶
docker run --rm -v dify_app_storage:/data -v /tmp/dify-backup:/backup alpine tar xzf /backup/dify-storage.tar.gz -C /data
```

### 3.6 ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆå¦‚éœ€è¦ï¼‰

```bash
# ç¼–è¾‘.envæ–‡ä»¶ï¼Œæ›´æ–°æœåŠ¡å™¨ç›¸å…³é…ç½®
nano .env

# å¸¸éœ€è¦ä¿®æ”¹çš„é…ç½®é¡¹ï¼š
# - æœåŠ¡å™¨IPåœ°å€
# - åŸŸåé…ç½®
# - ç«¯å£é…ç½®
# - å¤–éƒ¨æœåŠ¡åœ°å€ç­‰
```

### 3.7 å¯åŠ¨DifyæœåŠ¡

```bash
# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹å¯åŠ¨çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

## âœ… ç¬¬å››æ­¥ï¼šéªŒè¯è¿ç§»ç»“æœ

### 4.1 æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
docker-compose ps

# æ£€æŸ¥ç«¯å£æ˜¯å¦æ­£å¸¸ç›‘å¬
netstat -tulpn | grep -E ":(80|443|5432|6379)"

# æ£€æŸ¥å®¹å™¨æ—¥å¿—
docker-compose logs api
docker-compose logs web
```

### 4.2 åŠŸèƒ½æµ‹è¯•

```bash
# æµ‹è¯•APIå¥åº·æ£€æŸ¥
curl http://localhost/health

# æµ‹è¯•Webç•Œé¢ï¼ˆåœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼‰
# http://your-server-ip æˆ– https://your-domain
```

### 4.3 æ•°æ®å®Œæ•´æ€§éªŒè¯

- ç™»å½•ç®¡ç†åå°æ£€æŸ¥ç”¨æˆ·æ•°æ®
- éªŒè¯åº”ç”¨é…ç½®æ˜¯å¦å®Œæ•´
- æ£€æŸ¥ä¸Šä¼ çš„æ–‡ä»¶æ˜¯å¦æ­£å¸¸
- æµ‹è¯•AIå¯¹è¯åŠŸèƒ½

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜è§£å†³

#### 1. å®¹å™¨å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
docker-compose logs [service-name]

# æ£€æŸ¥ç«¯å£å†²çª
sudo lsof -i :80
sudo lsof -i :443
```

#### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥æ•°æ®åº“å®¹å™¨çŠ¶æ€
docker-compose exec db psql -U postgres -d dify

# é‡ç½®æ•°æ®åº“å¯†ç ï¼ˆå¦‚éœ€è¦ï¼‰
docker-compose exec db psql -U postgres -c "ALTER USER postgres PASSWORD 'your_password';"
```

#### 3. Redisè¿æ¥é—®é¢˜

```bash
# æµ‹è¯•Redisè¿æ¥
docker-compose exec redis redis-cli ping
```

#### 4. å­˜å‚¨æƒé™é—®é¢˜

```bash
# ä¿®å¤æ–‡ä»¶æƒé™
sudo chown -R 1001:1001 /var/lib/docker/volumes/dify_app_storage/_data
```

## ğŸ§¹ æ¸…ç†å·¥ä½œ

### æºæœåŠ¡å™¨æ¸…ç†ï¼ˆç¡®è®¤è¿ç§»æˆåŠŸåï¼‰

```bash
# åˆ é™¤å¤‡ä»½æ–‡ä»¶
rm -rf /tmp/dify-backup
rm /tmp/dify-migration-*.tar.gz

# å¦‚æœç¡®è®¤ä¸å†ä½¿ç”¨ï¼Œå¯ä»¥æ¸…ç†åŸéƒ¨ç½²
cd /path/to/old/dify
docker-compose down -v  # æ³¨æ„ï¼š-v ä¼šåˆ é™¤æ•°æ®å·
```

### ç›®æ ‡æœåŠ¡å™¨æ¸…ç†

```bash
# åˆ é™¤ä¸´æ—¶å¤‡ä»½æ–‡ä»¶
rm -rf /tmp/dify-backup
rm /tmp/dify-migration-*.tar.gz
```

## ğŸ“ é‡è¦æé†’

1. **åœ¨æ‰§è¡Œè¿ç§»å‰ï¼Œè¯·ç¡®ä¿å·²ç»å®Œæ•´æµ‹è¯•å¤‡ä»½æµç¨‹**
2. **å»ºè®®åœ¨ç»´æŠ¤æ—¶é—´çª—å£è¿›è¡Œè¿ç§»æ“ä½œ**
3. **è¿ç§»è¿‡ç¨‹ä¸­DifyæœåŠ¡ä¼šæš‚æ—¶ä¸å¯ç”¨**
4. **ç¡®è®¤æ–°æœåŠ¡å™¨çš„é˜²ç«å¢™å’Œå®‰å…¨ç»„é…ç½®æ­£ç¡®**
5. **å¦‚ä½¿ç”¨åŸŸåï¼Œè®°å¾—æ›´æ–°DNSè®°å½•**
6. **å»ºè®®ä¿ç•™æºæœåŠ¡å™¨å¤‡ä»½ä¸€æ®µæ—¶é—´ï¼Œä»¥é˜²éœ€è¦å›æ»š**


è¿ç§»å®Œæˆåï¼Œè®°å¾—æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œè¿ç»´æµç¨‹ï¼
