# ä¼ä¸šçº§æ—¥å¿—åˆ†æžé…ç½®ç¤ºä¾‹
# æ”¯æŒ ELK Stack (Elasticsearch, Logstash, Kibana) å’Œ Grafana + Prometheus

# ===========================================
# Logstash é…ç½® (logstash.conf)
# ===========================================
logstash_config: |
  input {
    # è¯»å– Nginx æ—¥å¿—æ–‡ä»¶
    file {
      path => "/var/log/nginx/access.log"
      start_position => "beginning"
      type => "nginx_access"
      codec => "json"
    }
    
    file {
      path => "/var/log/nginx/app_routing.log"
      start_position => "beginning"
      type => "app_routing"
      codec => "json"
    }
    
    file {
      path => "/var/log/nginx/security_audit.log"
      start_position => "beginning"
      type => "security_audit"
      codec => "json"
    }
    
    file {
      path => "/var/log/nginx/performance.log"
      start_position => "beginning"
      type => "performance"
      codec => "json"
    }
    
    file {
      path => "/var/log/nginx/error.log"
      start_position => "beginning"
      type => "nginx_error"
    }
  }
  
  filter {
    # å¤„ç†æ—¶é—´æˆ³
    if [timestamp] {
      date {
        match => [ "timestamp", "ISO8601" ]
      }
    }
    
    # æ·»åŠ åœ°ç†ä½ç½®ä¿¡æ¯
    if [remote_addr] {
      geoip {
        source => "remote_addr"
        target => "geoip"
      }
    }
    
    # è§£æž User-Agent
    if [http_user_agent] {
      useragent {
        source => "http_user_agent"
        target => "user_agent"
      }
    }
    
    # æ·»åŠ å‘Šè­¦çº§åˆ«
    if [type] == "security_audit" {
      mutate {
        add_field => { "alert_level" => "high" }
      }
    }
    
    if [status] >= 500 {
      mutate {
        add_field => { "alert_level" => "critical" }
      }
    } else if [status] >= 400 {
      mutate {
        add_field => { "alert_level" => "warning" }
      }
    }
    
    # æ€§èƒ½åˆ†ç±»
    if [request_time] {
      if [request_time] > 5.0 {
        mutate {
          add_field => { "performance_category" => "very_slow" }
        }
      } else if [request_time] > 2.0 {
        mutate {
          add_field => { "performance_category" => "slow" }
        }
      } else if [request_time] > 1.0 {
        mutate {
          add_field => { "performance_category" => "moderate" }
        }
      } else {
        mutate {
          add_field => { "performance_category" => "fast" }
        }
      }
    }
  }
  
  output {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "nginx-logs-%{+YYYY.MM.dd}"
    }
    
    # å‘é€å‘Šè­¦åˆ° Slack/é’‰é’‰
    if [alert_level] == "critical" {
      http {
        url => "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
        http_method => "post"
        format => "json"
        mapping => {
          "text" => "ðŸš¨ Critical Error: %{message}"
          "channel" => "#alerts"
        }
      }
    }
  }

# ===========================================
# Kibana ä»ªè¡¨æ¿é…ç½®
# ===========================================
kibana_dashboards:
  - name: "Nginx è®¿é—®æ¦‚è§ˆ"
    visualizations:
      - type: "line_chart"
        title: "è¯·æ±‚é‡è¶‹åŠ¿"
        metrics: "count"
        time_field: "@timestamp"
        
      - type: "pie_chart"
        title: "çŠ¶æ€ç åˆ†å¸ƒ"
        field: "status"
        
      - type: "data_table"
        title: "Top è®¿é—®IP"
        field: "remote_addr"
        
      - type: "heatmap"
        title: "å“åº”æ—¶é—´çƒ­åŠ›å›¾"
        x_axis: "@timestamp"
        y_axis: "request_time"
        
  - name: "å®‰å…¨ç›‘æŽ§"
    visualizations:
      - type: "line_chart"
        title: "å®‰å…¨äº‹ä»¶è¶‹åŠ¿"
        filter: 'type:"security_audit"'
        
      - type: "data_table"
        title: "å¯ç–‘IPåˆ—è¡¨"
        filter: 'alert_level:"high"'
        
      - type: "map"
        title: "æ”»å‡»æ¥æºåœ°å›¾"
        geo_field: "geoip.location"
        
  - name: "æ€§èƒ½ç›‘æŽ§"
    visualizations:
      - type: "histogram"
        title: "å“åº”æ—¶é—´åˆ†å¸ƒ"
        field: "request_time"
        
      - type: "line_chart"
        title: "å¹³å‡å“åº”æ—¶é—´"
        metrics: "avg"
        field: "request_time"
        
      - type: "data_table"
        title: "æ…¢æŸ¥è¯¢Top 10"
        filter: 'performance_category:"slow" OR performance_category:"very_slow"'

# ===========================================
# Grafana + Prometheus é…ç½®
# ===========================================
prometheus_config: |
  # prometheus.yml
  global:
    scrape_interval: 15s
    evaluation_interval: 15s
  
  rule_files:
    - "nginx_alerts.yml"
  
  scrape_configs:
    - job_name: 'nginx-exporter'
      static_configs:
        - targets: ['nginx-exporter:9113']
    
    - job_name: 'node-exporter'
      static_configs:
        - targets: ['node-exporter:9100']

grafana_dashboards:
  - name: "Nginx æ€§èƒ½ç›‘æŽ§"
    panels:
      - title: "è¯·æ±‚çŽ‡ (RPS)"
        type: "graph"
        query: "rate(nginx_http_requests_total[5m])"
        
      - title: "å¹³å‡å“åº”æ—¶é—´"
        type: "graph"
        query: "nginx_http_request_duration_seconds"
        
      - title: "é”™è¯¯çŽ‡"
        type: "graph"
        query: "rate(nginx_http_requests_total{status=~"4..|5.."}[5m])"
        
      - title: "æ´»è·ƒè¿žæŽ¥æ•°"
        type: "singlestat"
        query: "nginx_connections_active"
        
      - title: "çŠ¶æ€ç åˆ†å¸ƒ"
        type: "piechart"
        query: "nginx_http_requests_total"
        
  - name: "ä¸šåŠ¡ç›‘æŽ§"
    panels:
      - title: "å„åº”ç”¨ç±»åž‹è¯·æ±‚é‡"
        type: "graph"
        query: "rate(nginx_http_requests_total[5m]) by (app_type)"
        
      - title: "åŽç«¯å®žä¾‹è´Ÿè½½"
        type: "graph"
        query: "rate(nginx_http_requests_total[5m]) by (backend_instance)"
        
      - title: "ç”¨æˆ·æ´»è·ƒåº¦"
        type: "graph"
        query: "count by (user_id) (rate(nginx_http_requests_total[5m]))"

# ===========================================
# å‘Šè­¦è§„åˆ™é…ç½®
# ===========================================
alert_rules: |
  # nginx_alerts.yml
  groups:
    - name: nginx_alerts
      rules:
        - alert: NginxHighErrorRate
          expr: rate(nginx_http_requests_total{status=~"5.."}[5m]) > 0.1
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Nginx 5xxé”™è¯¯çŽ‡è¿‡é«˜"
            description: "5xxé”™è¯¯çŽ‡è¶…è¿‡10%ï¼ŒæŒç»­5åˆ†é’Ÿ"
            
        - alert: NginxSlowResponse
          expr: nginx_http_request_duration_seconds > 2
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: "Nginx å“åº”æ—¶é—´è¿‡æ…¢"
            description: "å¹³å‡å“åº”æ—¶é—´è¶…è¿‡2ç§’"
            
        - alert: NginxSecurityEvent
          expr: increase(nginx_security_events_total[5m]) > 10
          for: 1m
          labels:
            severity: high
          annotations:
            summary: "æ£€æµ‹åˆ°å®‰å…¨äº‹ä»¶"
            description: "5åˆ†é’Ÿå†…å®‰å…¨äº‹ä»¶è¶…è¿‡10æ¬¡"
            
        - alert: NginxHighTraffic
          expr: rate(nginx_http_requests_total[5m]) > 1000
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Nginx æµé‡è¿‡é«˜"
            description: "è¯·æ±‚çŽ‡è¶…è¿‡1000 RPSï¼ŒæŒç»­5åˆ†é’Ÿ"

# ===========================================
# æ—¥å¿—ä¿ç•™ç­–ç•¥
# ===========================================
log_retention_policy:
  elasticsearch:
    # ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†
    hot_phase: "7d"      # çƒ­æ•°æ®ä¿ç•™7å¤©
    warm_phase: "30d"    # æ¸©æ•°æ®ä¿ç•™30å¤©
    cold_phase: "90d"    # å†·æ•°æ®ä¿ç•™90å¤©
    delete_phase: "365d" # 1å¹´åŽåˆ é™¤
    
  file_system:
    access_logs: "30d"
    error_logs: "30d"
    security_logs: "90d"  # å®‰å…¨æ—¥å¿—ä¿ç•™æ›´é•¿æ—¶é—´
    performance_logs: "14d"

# ===========================================
# æ—¥å¿—åˆ†æžæŸ¥è¯¢ç¤ºä¾‹
# ===========================================
useful_queries:
  elasticsearch:
    # æŸ¥æ‰¾å¼‚å¸¸IP
    - "GET /nginx-logs-*/_search?q=status:>=400 AND remote_addr:* | head -100"
    
    # åˆ†æžAPIä½¿ç”¨æƒ…å†µ
    - "GET /nginx-logs-*/_search { \"aggs\": { \"api_usage\": { \"terms\": { \"field\": \"request_uri.keyword\" } } } }"
    
    # æ€§èƒ½åˆ†æž
    - "GET /nginx-logs-*/_search?q=request_time:>2.0 | sort @timestamp desc"
    
  kibana:
    # åˆ›å»ºè‡ªå®šä¹‰æœç´¢
    - "status:>=400 AND app_type:* | top 10 remote_addr"
    - "request_time:>1.0 | avg request_time by backend_instance"
    - "event_type:\"security_event\" | timeline @timestamp"