# Dify OpenResty è´Ÿè½½å‡è¡¡å™¨

ä¸€ä¸ªåŸºäº OpenResty çš„é«˜æ€§èƒ½ Dify AI åº”ç”¨è´Ÿè½½å‡è¡¡å™¨ï¼Œæ”¯æŒå¤šåº”ç”¨ã€å¤šå®ä¾‹çš„æ™ºèƒ½è·¯ç”±å’Œè´Ÿè½½å‡è¡¡ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
 â”‚   å®¢æˆ·ç«¯åº”ç”¨    â”‚â”€â”€â”€â–¶â”‚  OpenRestyè´Ÿè½½å‡è¡¡å™¨  â”‚â”€â”€â”€â–¶â”‚  Difyå®ä¾‹é›†ç¾¤   â”‚ 
 â”‚  (Web/Mobile)   â”‚    â”‚   (ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•)    â”‚    â”‚ (å¤šåº”ç”¨å¤šå®ä¾‹)  â”‚ 
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
                               â”‚ 
                               â–¼ 
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
                        â”‚  ç›‘æ§ç»Ÿè®¡API â”‚ 
                        â”‚ (/status)    â”‚ 
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¯¦ç»†æ¶æ„å›¾

```
Internet 
     â†“ 
 [Nginx Load Balancer] 
     â†“ 
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
 â”‚ Dify-1  â”‚ Dify-2  â”‚ Dify-3  â”‚ 
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
     â†“         â†“         â†“ 
 [å…±äº«PostgreSQLæ•°æ®åº“é›†ç¾¤] 
     â†“ 
 [å…±äº«Redisé›†ç¾¤] 
     â†“ 
 [å…±äº«å‘é‡æ•°æ®åº“]
```

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **ğŸ¯ æ™ºèƒ½è·¯ç”±**: åŸºäº Token è‡ªåŠ¨è¯†åˆ«åº”ç”¨ç±»å‹å¹¶è·¯ç”±åˆ°å¯¹åº”å®ä¾‹
- **âš–ï¸ è´Ÿè½½å‡è¡¡**: é‡‡ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å®ç°é«˜æ•ˆè´Ÿè½½åˆ†å¸ƒ
- **ğŸ”„ æ•…éšœè½¬ç§»**: è‡ªåŠ¨æ£€æµ‹å®ä¾‹å¥åº·çŠ¶æ€ï¼Œæ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢
- **ğŸ“Š å®æ—¶ç›‘æ§**: æä¾›è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯å’Œå¥åº·æ£€æŸ¥æ¥å£
- **ğŸš€ é«˜æ€§èƒ½**: é’ˆå¯¹ x86_64 æ¶æ„ä¼˜åŒ–ï¼Œæ”¯æŒé«˜å¹¶å‘å¤„ç†
- **ğŸ“ å¤šæ ¼å¼æ”¯æŒ**: æ”¯æŒ JSONã€Form-Data ç­‰å¤šç§è¯·æ±‚æ ¼å¼
- **ğŸ”§ çµæ´»é…ç½®**: æ”¯æŒå¤šåº”ç”¨ã€å¤šå®ä¾‹çš„çµæ´»é…ç½®

## ğŸ¯ é€‚ç”¨åœºæ™¯

- **å¤šåº”ç”¨éƒ¨ç½²**: ä¼ä¸šéœ€è¦åŒæ—¶è¿è¡Œå¤šä¸ª AI åº”ç”¨ï¼ˆæ™ºèƒ½å®¢æœã€å†…å®¹ç”Ÿæˆã€æ•°æ®åˆ†æç­‰ï¼‰
- **é«˜å¹¶å‘å¤„ç†**: å•ä¸ªåº”ç”¨å®ä¾‹æ— æ³•æ»¡è¶³å¤§é‡å¹¶å‘è¯·æ±‚
- **é«˜å¯ç”¨è¦æ±‚**: éœ€è¦é¿å…å•ç‚¹æ•…éšœï¼Œç¡®ä¿æœåŠ¡è¿ç»­æ€§
- **ç”¨æˆ·éš”ç¦»**: ä¸åŒç”¨æˆ·æˆ–ç§Ÿæˆ·éœ€è¦è®¿é—®ä¸åŒçš„åº”ç”¨å®ä¾‹
- **èµ„æºä¼˜åŒ–**: æ ¹æ®ä¸åŒåº”ç”¨ç‰¹ç‚¹è¿›è¡Œèµ„æºåˆ†é…å’Œè´Ÿè½½åˆ†æ‹…

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Docker & Docker Compose
- è‡³å°‘ 4GB å†…å­˜
- x86_64 æ¶æ„ï¼ˆæ¨èï¼‰

### å®‰è£…éƒ¨ç½²

1. **å…‹éš†é¡¹ç›®**
```bash
git clone <repository-url>
cd dify-openresty-loadbalancer
```

2. **é…ç½®åº”ç”¨**
```bash
# å¤åˆ¶é…ç½®ç¤ºä¾‹
cp examples/config_example.lua openresty/lua/config.lua

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim openresty/lua/config.lua
```

3. **å¯åŠ¨æœåŠ¡**
```bash
docker-compose up -d
```

4. **éªŒè¯éƒ¨ç½²**
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:82/health

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
curl http://localhost:82/status
```

## âš™ï¸ é…ç½®è¯´æ˜

### åº”ç”¨é…ç½®ç»“æ„

```lua
config.applications = {
    -- åº”ç”¨åç§°
    customer_service = {
        -- ç”¨æˆ·Tokenåˆ—è¡¨ï¼ˆç”¨äºè¯†åˆ«åº”ç”¨ç±»å‹ï¼‰
        user_tokens = {
            "usertoken--customer-service-v1"
        },
        -- åç«¯å®ä¾‹åˆ—è¡¨
        instances = {
            {
                name = "dify1",
                host = "172.20.62.200",
                port = 80,
                token = "app-9VSEFXR2qoMRoUHfmzxClGhe",
                weight = 1,
                max_fails = 3,
                fail_timeout = 30
            }
        }
    }
}
```

### ä¸€è‡´æ€§å“ˆå¸Œé…ç½®

```lua
config.consistent_hash = {
    virtual_nodes = 150,      -- è™šæ‹ŸèŠ‚ç‚¹æ•°é‡
    hash_algorithm = "crc32"  -- å“ˆå¸Œç®—æ³•: crc32, md5, sha1
}
```

## ğŸ”Œ API æ¥å£

### å¥åº·æ£€æŸ¥

```bash
GET /health
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
    "status": "ok",
    "timestamp": "2024-01-01T12:00:00Z"
}
```

### ç»Ÿè®¡ä¿¡æ¯

```bash
GET /status
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
    "applications": {
        "customer_service": {
            "total_requests": 1000,
            "instances": {
                "dify1": {
                    "requests": 334,
                    "status": "healthy"
                }
            }
        }
    }
}
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬è¯·æ±‚

```bash
curl -X POST 'http://localhost:82/v1/chat-messages' \
  --header 'Authorization: Bearer usertoken--customer-service-v1' \
  --header 'Content-Type: application/json' \
  --data '{
    "inputs": {},
    "query": "Hello, how are you?",
    "user": "user-123",
    "response_mode": "blocking"
  }'
```

### æ–‡ä»¶ä¸Šä¼ ï¼ˆForm-Dataï¼‰

```bash
curl -X POST 'http://localhost:82/v1/files/upload' \
  --header 'Authorization: Bearer usertoken--customer-service-v1' \
  --form 'user=user-123' \
  --form 'file=@localfile.png;type=image/png'
```

### æ”¯æŒçš„ç”¨æˆ·IDè·å–æ–¹å¼

è´Ÿè½½å‡è¡¡å™¨æ”¯æŒä»¥ä¸‹5ç§æ–¹å¼è·å–ç”¨æˆ·IDï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰ï¼š

1. **HTTPè¯·æ±‚å¤´** `X-User-ID`
2. **URLå‚æ•°** `user_id`
3. **Cookie** `user_id`
4. **JSONè¯·æ±‚ä½“** ä¸­çš„ `user` å­—æ®µ
5. **Form-Data** ä¸­çš„ `user` å­—æ®µ

## ğŸ“Š ç›‘æ§ä¸è¿ç»´

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose logs -f openresty-dify-lb

# æŸ¥çœ‹è®¿é—®æ—¥å¿—
tail -f openresty/logs/access.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f openresty/logs/error.log
```

### æ€§èƒ½ç›‘æ§

- **CPUä½¿ç”¨ç‡**: é€šè¿‡ `docker stats` ç›‘æ§
- **å†…å­˜ä½¿ç”¨**: é€šè¿‡ `docker stats` ç›‘æ§
- **è¯·æ±‚ç»Ÿè®¡**: é€šè¿‡ `/status` æ¥å£è·å–
- **å¥åº·çŠ¶æ€**: é€šè¿‡ `/health` æ¥å£æ£€æŸ¥

### æ•…éšœæ’æŸ¥

1. **æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•**
```bash
docker-compose exec openresty-dify-lb nginx -t
```

2. **é‡æ–°åŠ è½½é…ç½®**
```bash
docker-compose exec openresty-dify-lb nginx -s reload
```

3. **æŸ¥çœ‹å®ä¾‹å¥åº·çŠ¶æ€**
```bash
curl http://localhost:82/status | jq
```

## ğŸ”§ é«˜çº§é…ç½®

### æ€§èƒ½ä¼˜åŒ–

é’ˆå¯¹ x86_64 æ¶æ„çš„æ€§èƒ½ä¼˜åŒ–é…ç½®ï¼š

- **Workerè¿›ç¨‹**: è‡ªåŠ¨æ ¹æ®CPUæ ¸å¿ƒæ•°è®¾ç½®
- **è¿æ¥æ•°**: æ”¯æŒæœ€å¤§8192å¹¶å‘è¿æ¥
- **å†…å­˜ä¼˜åŒ–**: ä½¿ç”¨å…±äº«å­—å…¸ç¼“å­˜é…ç½®å’Œç»Ÿè®¡ä¿¡æ¯
- **CPUäº²å’Œæ€§**: è‡ªåŠ¨ç»‘å®šCPUæ ¸å¿ƒ

### SSL/HTTPS æ”¯æŒ

1. å°†SSLè¯ä¹¦æ”¾ç½®åœ¨ `openresty/ssl/` ç›®å½•
2. ä¿®æ”¹ `nginx.conf` é…ç½®SSL
3. é‡å¯æœåŠ¡

### è‡ªå®šä¹‰å¥åº·æ£€æŸ¥

å¯ä»¥é€šè¿‡ä¿®æ”¹ `loadbalancer.lua` ä¸­çš„å¥åº·æ£€æŸ¥é€»è¾‘æ¥è‡ªå®šä¹‰æ£€æŸ¥è§„åˆ™ã€‚

## ğŸ“š æ–‡æ¡£å‚è€ƒ

- [Form-Data æ”¯æŒè¯´æ˜](FORM_DATA_SUPPORT.md)
- [è¯¦ç»†æŠ€æœ¯æ–‡æ¡£](dify.md)
- [é…ç½®ç¤ºä¾‹](examples/config_example.lua)

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æ‰“å¼€ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ†˜ æ”¯æŒä¸åé¦ˆ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ [Issues](../../issues) ä¸­æ˜¯å¦æœ‰ç±»ä¼¼é—®é¢˜
2. åˆ›å»ºæ–°çš„ Issue æè¿°é—®é¢˜
3. æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œé…ç½®ä¿¡æ¯

---

**æ³¨æ„**: è¯·ç¡®ä¿åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å‰å……åˆ†æµ‹è¯•é…ç½®ï¼Œå¹¶æ ¹æ®å®é™…è´Ÿè½½æƒ…å†µè°ƒæ•´æ€§èƒ½å‚æ•°ã€‚